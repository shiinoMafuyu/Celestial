select concat(concat(t.billID, '- -'),to_char(bc.createtime, 'yyyymmdd-hh24miss')) stockId, --仓单号 仓单号拼接过户日期，把普通入库、拆单入库和过户入库统一起来 
       t.belonger customId, --所属交易商id
       t.breedId breedId, --所属品种分类Id
       '- -' commodityID, --商品编码
       
       t.warehouseId warehouseId, --仓库编号
       '-1' quantity, --商品数量
       t.quantity stockQuantity, --仓单数量
       t.frozenqty freezeQuantity, --冻结数量
       
       nvl(bc.createtime,t.createTime) createTime, --创建时间   同下面的查询条件
       nvl(t.updatetime, t.createTime) modifyTime, --修改时间
       '01' chgDirection, --仓单变动方向
       t.belongerType customType --用户类型
  from bl_bill t, BL_BillChgLog bc

 where 1 = 1
   and bc.billid(+) = t.billid
   and nvl(trunc(bc.createtime),trunc(t.CreateTime)) = ? --先找过户仓单里的创建时间为入库时间，找不到就是普通入库、拆单入库的，用原来的创建时间为入库时间
 
--整合出库：【普通、库存仓单】普通类 + 过户类

select concat(concat(t.billID, '- -'),to_char(bc.createtime, 'yyyymmdd-hh24miss')) stockId, --仓单号
       t.belonger customId, --所属交易商id
       t.breedId breedId, --所属品种分类Id
       '- -' commodityID, --商品编码
       
       t.warehouseId warehouseId, --仓库编号
       '-1' quantity, --商品数量
       DECODE(t.BillType,0, greatest(t.DismantleQty, t.OutApplyQty),(t.Quantity - t.DismantleQty)) stockQuantity, --仓单数量
       t.frozenqty freezeQuantity, --冻结数量
       
       nvl(bc.createTime, t.createTime) createTime, --创建时间
       nvl(t.updatetime,t.createTime) createTime, --修改时间
       '02' chgDirection, --仓单变动方向
       t.belongerType customType --用户类型
  from bl_bill t,
       (select max(bc0.createtime) createtime, bc0.billid from BL_BillChgLog bc0 group by bc0.billid) bc --过户类仓单中日期最大的  过户多次只取最后一次做为出库数据单号依据
 where 1 = 1
   and bc.billid(+) = t.billid
   and (t.OutApplyQty <> 0 or t.DismantleQty <> 0) --找出库了的或者拆单了的 做为出库数据
   and trunc(nvl(t.updatetime, t.createtime)) = ? -- 同入库